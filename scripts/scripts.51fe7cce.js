"use strict";angular.module("audioRecordingApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/record.html",controller:"RecordCtrl"}).when("/play",{templateUrl:"views/play.html",controller:"PlayCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("audioRecordingApp").factory("recorder",function(){return{Recorder:function(a,b){var c="scripts/recorderWorker.js",d=b||{},e=d.bufferLen||4096;this.context=a.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(e,2,2):this.node=this.context.createJavaScriptNode(e,2,2);var f=new Worker(d.workerPath||c);f.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var g,h=!1;this.node.onaudioprocess=function(a){h&&f.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(d[b]=a[b])},this.record=function(){h=!0},this.stop=function(){h=!1},this.clear=function(){f.postMessage({command:"clear"})},this.getBuffers=function(a){g=a||d.callback,f.postMessage({command:"getBuffers"})},this.exportWAV=function(a,b){if(g=a||d.callback,b=b||d.type||"audio/wav",!g)throw new Error("Callback not set");f.postMessage({command:"exportWAV",type:b})},this.exportMonoWAV=function(a,b){if(g=a||d.callback,b=b||d.type||"audio/wav",!g)throw new Error("Callback not set");f.postMessage({command:"exportMonoWAV",type:b})},f.onmessage=function(a){var b=a.data;g(b)},a.connect(this.node),this.node.connect(this.context.destination),this.setupDownload=function(a,b){var c=(window.URL||window.webkitURL).createObjectURL(a),d=document.getElementById("save"),e=document.getElementById("player");d.href=c,d.download=b||"output.wav",e.src=c}}}}),angular.module("audioRecordingApp").controller("RecordCtrl",["$scope","recorder","$timeout",function(a,b,c){function d(a){var b=Math.floor(a/1e3),c=Math.floor(b/86400),d=Math.floor(b%86400/3600),e=Math.floor(b%86400%3600/60),f="";return c>0&&(f+=c>1?c+" days ":c+" day "),d>0&&(f+=d>1?d+" hours ":d+" hour "),e>=0&&(f+=e>1?e+" minutes ":e+" minute "),b>=0&&(f+=b>1?b+" seconds ":e+" second "),f}function e(){q+=100,a.printTime=d(q),!a.recording&&c(e,100)}function f(a,b,c,d){var e=Math.ceil(d.length/a),f=b/2;c.fillStyle="silver",c.clearRect(0,0,a,b);for(var g=0;a>g;g++){for(var h=1,i=-1,j=0;e>j;j++){var k=d[g*e+j];h>k&&(h=k),k>i&&(i=k)}c.fillRect(g,(1+h)*f,1,Math.max(1,(i-h)*f))}}var g,h,i=new AudioContext,j=null,k=null,l=null,m=null,n=null,o=null,p=0,q=0;a.recording=!0,a.init=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices.getUserMedia,navigator.cancelAnimationFrame=navigator.cancelAnimationFrame||navigator.webkitCancelAnimationFrame||navigator.mozCancelAnimationFrame,navigator.requestAnimationFrame=navigator.requestAnimationFrame||navigator.webkitRequestAnimationFrame||navigator.mozRequestAnimationFrame,navigator.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},a.gotStream,function(a){alert("Error getting audio"),console.log(a)})},a.gotStream=function(c){l=i.createGain(),k=i.createMediaStreamSource(c),j=k,j.connect(l),a.analyserNode=i.createAnalyser(),a.analyserNode.fftSize=2048,l.connect(a.analyserNode),m=new b.Recorder(l),a.zeroGain=i.createGain(),a.zeroGain.gain.value=0,l.connect(a.zeroGain),a.zeroGain.connect(i.destination)},a.updateAnalysers=function(b){if(!o){var c=document.getElementById("analyser");g=c.width,h=c.height,o=c.getContext("2d")}var d=3,e=1,f=Math.round(g/d),i=new Uint8Array(a.analyserNode.frequencyBinCount);a.analyserNode.getByteFrequencyData(i),o.clearRect(0,0,g,h),o.fillStyle="#F6D565",o.lineCap="round";for(var j=a.analyserNode.frequencyBinCount/f,k=0;f>k;++k){for(var l=0,m=Math.floor(k*j),p=0;j>p;p++)l+=i[m+p];l/=j;i[k*j];o.fillStyle="hsl( "+Math.round(360*k/f)+", 100%, 50%)",o.fillRect(k*d,h,e,-l)}n=window.requestAnimationFrame(a.updateAnalysers)},a.cancelAnalyserUpdates=function(){window.cancelAnimationFrame(n),n=null},a.doneEncoding=function(a){m.setupDownload(a,"myRecording"+(10>p?"0":"")+p+".wav"),p++},a.gotBuffers=function(b){var c=document.getElementById("wavedisplay");f(c.width,c.height,c.getContext("2d"),b[0]),m.exportMonoWAV(a.doneEncoding)},a.beginRecording=function(){a.recording=!a.recording,a.recording?(a.cancelAnalyserUpdates(),m.stop(),m.getBuffers(a.gotBuffers)):(q=0,c(e,100),a.updateAnalysers(),m.clear(),m.record())},a.init()}]),angular.module("audioRecordingApp").controller("PlayCtrl",["$scope",function(a){}]);